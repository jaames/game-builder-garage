// RGBA color palette
export const TEXTURE_PALETTE = new Uint32Array(256);
// transparent
TEXTURE_PALETTE[0] = 0;
// grays
TEXTURE_PALETTE[1] = 0xffffffff;
TEXTURE_PALETTE[2] = 0xedededff;
TEXTURE_PALETTE[3] = 0xd9d9d9ff;
TEXTURE_PALETTE[4] = 0xb5b5b5ff;
TEXTURE_PALETTE[5] = 0x909090ff;
TEXTURE_PALETTE[6] = 0x6c6c6cff;
TEXTURE_PALETTE[7] = 0x484848ff;
TEXTURE_PALETTE[8] = 0x303030ff;
TEXTURE_PALETTE[9] = 0x000000ff;
// purples
TEXTURE_PALETTE[10] = 0xf3e6ffff;
TEXTURE_PALETTE[11] = 0xdcb3ffff;
TEXTURE_PALETTE[12] = 0xc685ffff;
TEXTURE_PALETTE[13] = 0x8800ffff;
TEXTURE_PALETTE[14] = 0x520099ff;
TEXTURE_PALETTE[15] = 0x29004dff;
TEXTURE_PALETTE[16] = 0xbb98d9ff;
TEXTURE_PALETTE[17] = 0x846d99ff;
TEXTURE_PALETTE[18] = 0x5b5266ff;
// light blues
TEXTURE_PALETTE[19] = 0xfee6ffff;
TEXTURE_PALETTE[20] = 0xfbb3ffff;
TEXTURE_PALETTE[21] = 0xf985ffff;
TEXTURE_PALETTE[22] = 0xf200ffff;
TEXTURE_PALETTE[23] = 0xc200ccff;
TEXTURE_PALETTE[24] = 0x7a0080ff;
TEXTURE_PALETTE[25] = 0xd698d9ff;
TEXTURE_PALETTE[26] = 0x7d4080ff;
TEXTURE_PALETTE[27] = 0x4b1f4dff;
// light greens
TEXTURE_PALETTE[28] = 0xffe6f5ff;
TEXTURE_PALETTE[29] = 0xffb3dfff;
TEXTURE_PALETTE[30] = 0xff85ccff;
TEXTURE_PALETTE[31] = 0xff0095ff;
TEXTURE_PALETTE[32] = 0xcc0077ff;
TEXTURE_PALETTE[33] = 0x80004bff;
TEXTURE_PALETTE[34] = 0xd998beff;
TEXTURE_PALETTE[35] = 0x80536dff;
TEXTURE_PALETTE[36] = 0x4d1f3aff;
// reds
TEXTURE_PALETTE[37] = 0xe6fbffff;
TEXTURE_PALETTE[38] = 0xccf7ffff;
TEXTURE_PALETTE[39] = 0x85ebffff;
TEXTURE_PALETTE[40] = 0x00d5ffff;
TEXTURE_PALETTE[41] = 0x00aaccff;
TEXTURE_PALETTE[42] = 0x006b80ff;
TEXTURE_PALETTE[43] = 0x98ced9ff;
TEXTURE_PALETTE[44] = 0x5a7a80ff;
TEXTURE_PALETTE[45] = 0x36484dff;
// magentas
TEXTURE_PALETTE[46] = 0xe6f2ffff;
TEXTURE_PALETTE[47] = 0xb3d6ffff;
TEXTURE_PALETTE[48] = 0x85beffff;
TEXTURE_PALETTE[49] = 0x1080ffff;
TEXTURE_PALETTE[50] = 0x005fccff;
TEXTURE_PALETTE[51] = 0x003c80ff;
TEXTURE_PALETTE[52] = 0x98b6d9ff;
TEXTURE_PALETTE[53] = 0x405e80ff;
TEXTURE_PALETTE[54] = 0x1f344dff;
// regular blues
TEXTURE_PALETTE[55] = 0xe8e6ffff;
TEXTURE_PALETTE[56] = 0xd0ccffff;
TEXTURE_PALETTE[57] = 0xa199ffff;
TEXTURE_PALETTE[58] = 0x1500ffff;
TEXTURE_PALETTE[59] = 0x0f00b3ff;
TEXTURE_PALETTE[60] = 0x07004dff;
TEXTURE_PALETTE[61] = 0xb2aed9ff;
TEXTURE_PALETTE[62] = 0x656282ff;
TEXTURE_PALETTE[63] = 0x3b3a4dff;
// regular greens
TEXTURE_PALETTE[64] = 0xf7ffe6ff;
TEXTURE_PALETTE[65] = 0xe6ffb3ff;
TEXTURE_PALETTE[66] = 0xd6ff85ff;
TEXTURE_PALETTE[67] = 0xaaff00ff;
TEXTURE_PALETTE[68] = 0x90d900ff;
TEXTURE_PALETTE[69] = 0x558000ff;
TEXTURE_PALETTE[70] = 0xc4d998ff;
TEXTURE_PALETTE[71] = 0x89996cff;
TEXTURE_PALETTE[72] = 0x3d4d1fff;
// oranges
TEXTURE_PALETTE[73] = 0xccffd3ff;
TEXTURE_PALETTE[74] = 0x99ffaaff;
TEXTURE_PALETTE[75] = 0x66ff7eff;
TEXTURE_PALETTE[76] = 0x00D924ff;
TEXTURE_PALETTE[77] = 0x009919ff;
TEXTURE_PALETTE[78] = 0x00590eff;
TEXTURE_PALETTE[79] = 0x86bf90ff;
TEXTURE_PALETTE[80] = 0x598060ff;
TEXTURE_PALETTE[81] = 0x1f3323ff;
// pinks
TEXTURE_PALETTE[82] = 0xe6fffaff;
TEXTURE_PALETTE[83] = 0xb3fff0ff;
TEXTURE_PALETTE[84] = 0x85ffe7ff;
TEXTURE_PALETTE[85] = 0x00ffcfff;
TEXTURE_PALETTE[86] = 0x00cca3ff;
TEXTURE_PALETTE[87] = 0x008066ff;
TEXTURE_PALETTE[88] = 0x98d9ccff;
TEXTURE_PALETTE[89] = 0x6b9990ff;
TEXTURE_PALETTE[90] = 0x1f4d43ff;
// deep blues
TEXTURE_PALETTE[91] = 0xffe6e6ff;
TEXTURE_PALETTE[92] = 0xffb3b3ff;
TEXTURE_PALETTE[93] = 0xff8585ff;
TEXTURE_PALETTE[94] = 0xff0000ff;
TEXTURE_PALETTE[95] = 0xcc0012ff;
TEXTURE_PALETTE[96] = 0x800000ff;
TEXTURE_PALETTE[97] = 0xd95757ff;
TEXTURE_PALETTE[98] = 0x804040ff;
TEXTURE_PALETTE[99] = 0x4d1f1fff;
// turquoises
TEXTURE_PALETTE[100] = 0xfff0e6ff;
TEXTURE_PALETTE[101] = 0xffd3b3ff;
TEXTURE_PALETTE[102] = 0xffb885ff;
TEXTURE_PALETTE[103] = 0xff6a00ff;
TEXTURE_PALETTE[104] = 0xcc5500ff;
TEXTURE_PALETTE[105] = 0x803500ff;
TEXTURE_PALETTE[106] = 0xd9b398ff;
TEXTURE_PALETTE[107] = 0x805b40ff;
TEXTURE_PALETTE[108] = 0x4d321fff;
// yellows
TEXTURE_PALETTE[109] = 0xfffde6ff;
TEXTURE_PALETTE[110] = 0xfffab3ff;
TEXTURE_PALETTE[111] = 0xfff785ff;
TEXTURE_PALETTE[112] = 0xffee00ff;
TEXTURE_PALETTE[113] = 0xccbe00ff;
TEXTURE_PALETTE[114] = 0x807700ff;
TEXTURE_PALETTE[115] = 0xbfbb86ff;
TEXTURE_PALETTE[116] = 0x807e5aff;
TEXTURE_PALETTE[117] = 0x4d4b32ff;

export class GameTexture {

  get [Symbol.toStringTag]() { return 'Texture' };

  public width = 64;
  public height = 64;
  public id = -1;
  public pixels: Uint8Array;
  public palette = TEXTURE_PALETTE;

  constructor(pixels?: Uint8Array, id: number = -1) {
    this.pixels = pixels ? pixels : new Uint8Array(64 * 64);
    this.id = id;
  }

  public getPixel(x: number, y: number) {
    const ptr = y * this.width + x;
    return this.pixels[ptr];
  }

  public setPixel(x: number, y: number, value: number) {
    // ignore out-of-bounds pixels
    if (x >= 0 && y >= 0 && x < this.width && y < this.height) {
      const ptr = y * this.width + x;
      this.pixels[ptr] = value;
    }
  }

  public getPixels() {
    return this.pixels;
  }

  public setPixels(newPixels: Uint8Array) {
    this.pixels.set(newPixels);
  }

  public clearPixels() {
    this.pixels.fill(0);
  }

  public getRgbaPixels() {
    const src = this.pixels;
    const dst = new Uint32Array(this.width * this.height);
    const palette = this.palette;
    for (let i = 0, len = src.length; i < len; i++)
      dst[i] = palette[src[i]];
    return dst;
  }

  public getImageData(ctx: CanvasRenderingContext2D) {
    const imgData = ctx.createImageData(this.width, this.height);
    const palette = new Uint8Array(this.palette.buffer);
    const src = this.pixels;
    const dst = imgData.data;
    for (let i = 0, len = src.length; i < len; i++) {
      const px = src[i];
      dst[i * 4 + 3] = palette[px * 4 + 0];
      dst[i * 4 + 2] = palette[px * 4 + 1];
      dst[i * 4 + 1] = palette[px * 4 + 2];
      dst[i * 4 + 0] = palette[px * 4 + 3];
    }
    return imgData;
  }

  public getCanvas() {
    const canvas = document.createElement('canvas');
    canvas.width = this.width;
    canvas.height = this.height;
    const ctx = canvas.getContext('2d');
    const imgData = this.getImageData(ctx);
    ctx.putImageData(imgData, 0, 0);
    return canvas;
  }

  // TODO: use gif URLs instead, better than creating a canvas per texture...
  public getUrl() {
    const canvas = this.getCanvas();
    return canvas.toDataURL();
  }

}